{% extends "base.html" %}

{% block title %}Trading - IQ Option Trading Bot{% endblock %}

{% block content %}
<div class="trading-container">
    <div class="trading-header">
        <h1>üíπ Trading</h1>
        <p>Execute opera√ß√µes de trading</p>
    </div>
    
    <div class="trading-form-card">
        <div class="form-group">
            <label for="trading_mode">Modo de Trading</label>
            <select id="trading_mode" name="trading_mode" required>
                <option value="manual">Trading Manual</option>
                <option value="analise">An√°lise de Mercado</option>
                <option value="streaming">Streaming de Dados em Tempo Real</option>
                <option value="portfolio">Gerenciamento de Portfolio</option>
            </select>
        </div>
        
        <!-- Formul√°rio de Trading Manual -->
        <div id="manualTradingForm" style="display: block;">
        <form id="tradingForm">
            <div class="form-group">
                <label for="asset">Ativo</label>
                <input type="text" id="asset" name="asset" placeholder="EURUSD, EURUSD-OTC, etc." required>
            </div>
            
            <div class="form-group">
                <label for="direction">Dire√ß√£o</label>
                <select id="direction" name="direction" required>
                    <option value="call">CALL (Alta)</option>
                    <option value="put">PUT (Baixa)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="amount">Valor ($)</label>
                <input type="number" id="amount" name="amount" min="0.1" step="0.1" required>
            </div>
            
            <div class="form-group">
                <label for="expiry">Expira√ß√£o (minutos)</label>
                <select id="expiry" name="expiry" required>
                    <option value="1">1 minuto</option>
                    <option value="5" selected>5 minutos</option>
                    <option value="15">15 minutos</option>
                    <option value="30">30 minutos</option>
                    <option value="60">1 hora</option>
                </select>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large">Executar Opera√ß√£o</button>
            </div>
            
            <div id="tradingMessage" class="alert" style="display: none;"></div>
        </form>
        </div>
        
        <!-- Formul√°rio de An√°lise de Mercado -->
        <div id="analiseForm" style="display: none;">
            <div class="sinais-info">
                <p><strong>An√°lise de Mercado</strong></p>
                <p>Esta estrat√©gia permite analisar tend√™ncias e padr√µes do mercado antes de executar opera√ß√µes.</p>
                <p>Recursos dispon√≠veis:</p>
                <ul class="config-list">
                    <li>An√°lise t√©cnica de indicadores</li>
                    <li>Identifica√ß√£o de tend√™ncias</li>
                    <li>An√°lise de suporte e resist√™ncia</li>
                    <li>Recomenda√ß√µes baseadas em dados hist√≥ricos</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-large" onclick="showAlert('Funcionalidade em desenvolvimento', 'info', 'Em Desenvolvimento')">Iniciar An√°lise</button>
            </div>
        </div>
        
        <!-- Formul√°rio de Streaming de Dados -->
        <div id="streamingForm" style="display: none;">
            <div class="sinais-info">
                <p><strong>Streaming de Dados em Tempo Real</strong></p>
                <p>Monitore dados de mercado em tempo real para tomar decis√µes informadas.</p>
                <p>Recursos dispon√≠veis:</p>
                <ul class="config-list">
                    <li>Atualiza√ß√µes de pre√ßos em tempo real</li>
                    <li>Grafos e indicadores ao vivo</li>
                    <li>Alertas de mudan√ßas significativas</li>
                    <li>An√°lise de volume e volatilidade</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-large" onclick="showAlert('Funcionalidade em desenvolvimento', 'info', 'Em Desenvolvimento')">Iniciar Streaming</button>
            </div>
        </div>
        
        <!-- Formul√°rio de Gerenciamento de Portfolio -->
        <div id="portfolioForm" style="display: none;">
            <div class="sinais-info">
                <p><strong>Gerenciamento de Portfolio</strong></p>
                <p>Gerencie seu portfolio de opera√ß√µes e monitore performance.</p>
                <p>Recursos dispon√≠veis:</p>
                <ul class="config-list">
                    <li>Visualiza√ß√£o de posi√ß√µes abertas</li>
                    <li>An√°lise de performance geral</li>
                    <li>Distribui√ß√£o de risco</li>
                    <li>Relat√≥rios e estat√≠sticas</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-large" onclick="showAlert('Funcionalidade em desenvolvimento', 'info', 'Em Desenvolvimento')">Ver Portfolio</button>
            </div>
        </div>
    </div>
    
    <div class="trading-history">
        <h2>Hist√≥rico Recente</h2>
        <div id="historyContainer" class="history-list">
            <p class="text-muted">Carregando hist√≥rico...</p>
        </div>
    </div>
</div>

<script>
const history = [];

// Alternar entre diferentes modos de trading
document.getElementById('trading_mode').addEventListener('change', function() {
    const mode = this.value;
    const manualForm = document.getElementById('manualTradingForm');
    const analiseForm = document.getElementById('analiseForm');
    const streamingForm = document.getElementById('streamingForm');
    const portfolioForm = document.getElementById('portfolioForm');
    
    // Ocultar todos os formul√°rios
    manualForm.style.display = 'none';
    analiseForm.style.display = 'none';
    streamingForm.style.display = 'none';
    portfolioForm.style.display = 'none';
    
    // Mostrar o formul√°rio correspondente ao modo selecionado
    switch(mode) {
        case 'manual':
            manualForm.style.display = 'block';
            break;
        case 'analise':
            analiseForm.style.display = 'block';
            break;
        case 'streaming':
            streamingForm.style.display = 'block';
            break;
        case 'portfolio':
            portfolioForm.style.display = 'block';
            break;
    }
});

document.getElementById('tradingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const asset = document.getElementById('asset').value.toUpperCase();
    const direction = document.getElementById('direction').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const expiry = parseInt(document.getElementById('expiry').value);
    
    const messageDiv = document.getElementById('tradingMessage');
    const submitBtn = this.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Executando...';
    
    try {
        const response = await fetch('/api/trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                asset: asset,
                direction: direction,
                amount: amount,
                expiry: expiry
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageDiv.className = 'alert alert-success';
            messageDiv.textContent = `Opera√ß√£o executada com sucesso! Order ID: ${data.order_id}`;
            messageDiv.style.display = 'block';
            
            // Adicionar ao hist√≥rico
            history.unshift({
                asset: asset,
                direction: direction.toUpperCase(),
                amount: amount,
                expiry: expiry,
                order_id: data.order_id,
                timestamp: new Date().toLocaleString(),
                balance: data.balance
            });
            
            loadHistory();
            
            // Limpar formul√°rio
            this.reset();
        } else {
            messageDiv.className = 'alert alert-error';
            messageDiv.textContent = data.error || 'Erro ao executar opera√ß√£o';
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-error';
        messageDiv.textContent = 'Erro de conex√£o: ' + error.message;
        messageDiv.style.display = 'block';
    }
    
    submitBtn.disabled = false;
    submitBtn.textContent = 'Executar Opera√ß√£o';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
});

// Carregar hist√≥rico do servidor
async function loadHistory() {
    try {
        const response = await fetch('/api/trade/history');
        const data = await response.json();
        
        updateHistoryDisplay(data.history || []);
    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        document.getElementById('historyContainer').innerHTML = '<p class="text-muted">Erro ao carregar hist√≥rico</p>';
    }
}

function updateHistoryDisplay(history) {
    const container = document.getElementById('historyContainer');
    
    if (history.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhuma opera√ß√£o ainda</p>';
        return;
    }
    
    // Separar trades principais (n√£o s√£o Martingale) dos trades de Martingale
    // Trade principal: n√£o √© Martingale E n√£o tem parent_trade_id
    const mainTrades = history.filter(t => !t.is_martingale && !t.parent_trade_id);
    const martingaleTrades = history.filter(t => t.is_martingale && t.parent_trade_id);
    
    let html = '<div class="history-items">';
    
    // Mostrar apenas trades principais (agrupando Martingales)
    mainTrades.slice(0, 20).forEach(trade => {
        const statusBadge = getStatusBadge(trade.status);
        const timeStr = new Date(trade.timestamp).toLocaleString('pt-BR');
        
        // Encontrar todos os Martingales relacionados a este trade
        // Buscar todos que t√™m este trade como pai (direto ou indireto)
        function findRelatedMartingales(tradeId) {
            const direct = martingaleTrades.filter(t => t.parent_trade_id === tradeId);
            const indirect = [];
            direct.forEach(mt => {
                indirect.push(...findRelatedMartingales(mt.id));
            });
            return [...direct, ...indirect];
        }
        
        const relatedTrades = findRelatedMartingales(trade.id).sort((a, b) => a.martingale_level - b.martingale_level);
        
        const hasMartingale = relatedTrades.length > 0;
        const lastMartingale = relatedTrades.length > 0 ? relatedTrades[relatedTrades.length - 1] : null;
        
        // Pode executar Martingale se trade perdeu e n√£o tem Martingale pendente
        let canExecuteMartingale = false;
        if (trade.status === 'loss') {
            if (!hasMartingale) {
                canExecuteMartingale = true;
            } else if (lastMartingale && lastMartingale.status !== 'pending' && lastMartingale.status === 'loss') {
                canExecuteMartingale = true;
            }
        }
        
        html += `
            <div class="history-item ${trade.status === 'loss' ? 'history-item-loss' : trade.status === 'win' ? 'history-item-win' : ''}">
                <div class="history-main">
                    <div class="history-header">
                        <span class="history-asset">${trade.asset}</span>
                        <span class="badge badge-${trade.direction === 'CALL' ? 'success' : 'danger'}">${trade.direction}</span>
                        ${statusBadge}
                    </div>
                    ${trade.sinal ? `<div class="history-sinal"><strong>Sinal Enviado:</strong> ${trade.sinal}</div>` : ''}
                    ${hasMartingale ? `
                        <div class="history-martingale-chain">
                            <strong>Cadeia de Martingale:</strong>
                            ${relatedTrades.map((mt, idx) => `
                                <span class="badge badge-warning">M${idx + 1}: ${mt.status === 'pending' ? 'Aguardando' : mt.status === 'win' ? 'WIN' : mt.status === 'loss' ? 'LOSS' : 'EQUAL'} ($${mt.amount.toFixed(2)})</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${canExecuteMartingale ? `
                        <div class="history-martingale-action">
                            <button class="btn btn-sm btn-warning" onclick="executarMartingale(${trade.id}, '${trade.asset}', '${trade.direction}', ${trade.expiry}, ${relatedTrades.length})">
                                Executar Martingale ${relatedTrades.length + 1}
                            </button>
                        </div>
                    ` : ''}
                </div>
                <div class="history-details">
                    <span><strong>Valor:</strong> $${trade.amount.toFixed(2)}</span>
                    <span><strong>Expira√ß√£o:</strong> ${trade.expiry} min</span>
                    <span><strong>ID:</strong> ${trade.id}</span>
                    ${trade.status !== 'pending' ? `<span class="history-profit ${trade.profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        <strong>Resultado ${trade.status === 'win' ? 'WIN' : trade.status === 'loss' ? 'LOSS' : 'EQUAL'}:</strong> 
                        $${trade.profit.toFixed(2)}
                    </span>` : '<span class="history-status-pending">Aguardando resultado...</span>'}
                    <span class="history-time">${timeStr}</span>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function getStatusBadge(status) {
    switch(status) {
        case 'win':
            return '<span class="badge badge-success">WIN</span>';
        case 'loss':
            return '<span class="badge badge-danger">LOSS</span>';
        case 'equal':
            return '<span class="badge badge-info">EQUAL</span>';
        default:
            return '<span class="badge badge-secondary">PENDENTE</span>';
    }
}

// Executar Martingale
async function executarMartingale(parentId, asset, direction, expiry, martingaleLevel = 0) {
    try {
        // Obter hist√≥rico completo para calcular valor correto
        const historyResponse = await fetch('/api/trade/history');
        const historyData = await historyResponse.json();
        
        // Encontrar a opera√ß√£o pai original (n√£o martingale)
        let baseTrade = historyData.history.find(t => t.id === parentId);
        if (!baseTrade) {
            await showAlert('Opera√ß√£o pai n√£o encontrada', 'error');
            return;
        }
        
        // Encontrar o √∫ltimo martingale da cadeia
        const martingaleChain = historyData.history.filter(t => {
            let current = t;
            while (current && current.parent_trade_id) {
                if (current.parent_trade_id === parentId) return true;
                current = historyData.history.find(h => h.id === current.parent_trade_id);
            }
            return false;
        }).sort((a, b) => a.martingale_level - b.martingale_level);
        
        // Calcular valor do Martingale (dobrar o valor da √∫ltima opera√ß√£o da cadeia)
        let lastAmount = baseTrade.amount;
        if (martingaleChain.length > 0) {
            const lastMartingale = martingaleChain[martingaleChain.length - 1];
            lastAmount = lastMartingale.amount;
        }
        
        const martingaleAmount = lastAmount * 2.15;
        const nextLevel = martingaleLevel + 1;
        
        const details = `Ativo: ${asset}\nDire√ß√£o: ${direction}\nValor: $${martingaleAmount.toFixed(2)} (valor anterior √ó 2.15)`;
        const confirmed = await showConfirm(`Deseja executar Martingale ${nextLevel} para recuperar a perda?`, 'Confirmar Martingale', details);
        
        if (!confirmed) {
            return;
        }
        
        const response = await fetch('/api/trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                asset: asset,
                direction: direction.toLowerCase(),
                amount: martingaleAmount,
                expiry: expiry,
                is_martingale: true,
                parent_trade_id: parentId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Recarregar hist√≥rico automaticamente
            loadHistory();
        } else {
            await showAlert('Erro ao executar Martingale: ' + (data.error || 'Erro desconhecido'), 'error');
        }
    } catch (error) {
        await showAlert('Erro ao executar Martingale: ' + error.message, 'error');
    }
}

// Atualizar hist√≥rico a cada 5 segundos
setInterval(loadHistory, 5000);

// Carregar hist√≥rico ao iniciar
loadHistory();
</script>
{% endblock %}

